<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/async.html">

<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">

<link rel="import" href="/src/typio-app/shared-styles.html">
<link rel="import" href="/src/typio-app/typio-intro-screen.html">
<link rel="import" href="/src/typio-app/typio-catalog-screen.html">
<link rel="import" href="/src/typio-app/typio-practice-screen.html">
<link rel="import" href="/src/typio-app/typio-drill-runner-screen.html">
<link rel="import" href="/src/typio-app/typio-drill-creator-screen.html">

<dom-module id="typio-app">
  <template>
    <style include="shared-styles">

      :host {
        display: block;
      }

      /*
       * All sections of the website are displayed full-screen.
       * We use sliding animations to pass from one screen to another one.
       */

      iron-pages > * {
        position: fixed;
        width: 100%;
        height: 100%;
        margin: 0;
      }

      /*
      TODO uncomment this to renable animations between screens
    
      typio-catalog.iron-selected {
        animation-duration: 0.2s;
        animation-name: slide-from-top;
      }
      typio-drill-creator.iron-selected {
        animation-duration: 0.2s;
        animation-name: slide-from-bottom;
      }
      */
      
      /*
       * Menu
       */

      app-toolbar {
        background-color: var(--typio-bg-color);
        color: white;
        font-family: var(--logo-font-family);
      }

      paper-icon-button {
        --paper-icon-button-ink-color: white;
      }

      paper-icon-button + [main-title] {
        margin-left: 24px;
      }
      app-header {
        color: #fff;
        box-shadow: 0 5px 5px rgba(0, 0, 0, 0.3);
        position: sticky;
        top: 0;
        z-index: 100;
        --app-header-background-rear-layer: {
          background-color: #ef6c00;
        };
      }
      app-drawer {
        z-index: 50;
        --app-drawer-scrim-background: rgba(255, 255, 255, 0.8);
        --app-drawer-content-container: {
          background-color: white;
        }
      }
      app-drawer nav {
        margin-top: 100px;
      }
      app-drawer nav ul {
        list-style-type: none;
      }
      app-drawer nav li {
        border: none;
      }
      app-toolbar a {
        text-decoration: none;
        color: inherit;
        margin-left: 25px;
      }
      app-drawer a {
        text-decoration: none;
        color: inherit;
      }
      
      app-header.menu-false {
        display: none;
      }

    </style>

    <app-location route="{{route}}"></app-location>
    <app-route
        route="{{route}}"
        pattern="/:view"
        data="{{routeData}}"
        tail="{{subroute}}">
    </app-route>

    <iron-a11y-keys id="a11y" target="[[target]]" keys="ctrl+enter" on-keys-pressed="start"></iron-a11y-keys>
    <iron-a11y-keys id="a11y" target="[[target]]" keys="ctrl+shift+home" on-keys-pressed="back"></iron-a11y-keys>
    <iron-a11y-keys id="a11y" target="[[target]]" keys="ctrl+alt+i" on-keys-pressed="goToIntro"></iron-a11y-keys>
    <iron-a11y-keys id="a11y" target="[[target]]" keys="ctrl+alt+e" on-keys-pressed="goToDrillEditor"></iron-a11y-keys>
    <iron-a11y-keys id="a11y" target="[[target]]" keys="ctrl+alt+d" on-keys-pressed="goToDrillSession"></iron-a11y-keys>
    <iron-a11y-keys id="a11y" target="[[target]]" keys="ctrl+alt+p" on-keys-pressed="goToPracticeSession"></iron-a11y-keys>
    <iron-a11y-keys id="a11y" target="[[target]]" keys="ctrl+alt+c" on-keys-pressed="goToCatalog"></iron-a11y-keys>
    
    <app-header effects="waterfall" class$="menu-{{menuVisible}}">
      <app-toolbar>
        <paper-icon-button icon="menu" on-click="_toggleDrawer"></paper-icon-button>
        <a href="/intro">TYPIO</a>
        <div main-title></div>
        <paper-icon-button icon="hardware:keyboard"></paper-icon-button>
        <a href="/catalog"><paper-icon-button icon="close"></paper-icon-button></a>
      </app-toolbar>
    </app-header>
    <app-drawer id="drawer" swipe-open>
      <nav>
        <ul>
          <li><paper-icon-button icon="view-module"></paper-icon-button> <a href="/catalog">Consult the catalog</a></li>
          <li><paper-icon-button icon="create"></paper-icon-button> <a href="/drillCreator">Create a drill</a></li>
        </ul>
      </nav>
    </app-drawer>
    
    <iron-pages selected="[[routeData.view]]" attr-for-selected="name">
      <typio-intro-screen id="intro" name="intro"></typio-intro-screen>
      <typio-catalog-screen id="catalog" name="catalog" on-entry-selected="_initCodeEditor" route="{{subroute}}"></typio-catalog-screen>
      <typio-practice-screen id="editor" name="editor" route="{{route}}"></typio-practice-screen>
      <typio-drill-runner-screen id="drillRunner" name="drillRunner" route="{{subroute}}"></typio-drill-runner-screen>
      <typio-drill-creator-screen id="drillCreator" name="drillCreator" route="{{subroute}}"></typio-drill-creator-screen>
    </intro-pages>

  </template>

  <script>
    /**
     * Top-level element.
     *
     * @customElement
     * @polymer
     */
    class TypioApp extends Polymer.Element {
      static get is() { return 'typio-app'; }
      static get properties() {
        return {

          //
          // Routing management
          //

          route: {
            type: Object
          },

          routeData: {
            type: Object,
            // https://www.polymer-project.org/2.0/docs/devguide/observers#dynamic-observers
            observer: '_routeDataChanged'
          },

          _scrollPositionMap: {
            type: Object,
            value: function() {
              return {};
            }
          },
          
          /**
           * Top-Menu visible?
           */
          menuVisible: {
            type: Boolean,
            value: true
          },
          
          
          // 
          // Shortcuts management
          //
          
          target: {
            type: Object,
            value: function() {
              return document.body;
            }
          },
          
        };
      }

      ready() {
        super.ready();

        // Force homepage if no page is defined
        if (!this.route.path || this.route.path === '/') {
          this.set('route.path', '/intro');
        }
        
        this.addEventListener('drill-session-requested', this.drillSessionRequested);
      }
      


      /**
       * Preserves the document scroll position, so
       * it can be restored when returning to a page.
       */
      _routeDataChanged(pageData, oldPageData) {
        var map = this._scrollPositionMap;
        if (oldPageData != null && oldPageData.view != null) {
          map[oldPageData.view] = window.pageYOffset;
        }

        this._selectedPage = pageData.view;

        // Hide the menu when displaying introduction page
        this.menuVisible = this._selectedPage !== 'intro';
        
        // Cancel the editor to stop listening keypress
        if (oldPageData && oldPageData.view === 'editor') {
          this.$.editor.cancel();
        }
        
        if (map[pageData.view] != null) {
          Polymer.AppLayout.scroll({ top: map[pageData.view], behavior: 'silent' });
        } else if (this.isAttached) {
          Polymer.AppLayout.scroll({ top: 0, behavior: 'silent' });
        }
      }

      /**
      * Called when the user select a content inside the catalog.
      * Initialise the edttor with the resource metadata.
       */
      _initCodeEditor(e, detail) {
        this.$.editor.content = detail.content;
        this.$.editor.type = detail.type;
        this.$.editor.language = detail.language;
        this.$.editor.resource = detail.resource;
        this.$.editor.resourceItem = detail.resourceItem;
        this.$.editor.reset();
        this.set('route.path', '/editor');
      }
      
      //
      // Navigation
      //
      
      goToIntro() {
        this.set('route.path', '/intro');
      }
      goToDrillEditor() {
        this.set('route.path', '/drillCreator');
      }
      goToDrillSession() {
        this.set('route.path', '/drillRunner');
      }
      goToPracticeSession() {
        this.set('route.path', '/editor');
      }
      goToCatalog() {
        this.set('route.path', '/catalog');
      }
      
      start() {
        let screen = this._currentScreen();
        if (screen.startable) {
          screen.startable();
        }
      }
      
      back() {
        let screen = this._currentScreen();
        if (screen.backable) {
          screen.backable();
        }
      }
      
      _currentScreen() {
        switch (this.route.path) {
          case '/intro':
            return this.$.intro;
          case '/catalog':
            return this.$.catalog;
          case '/editor':
            return this.$.editor;
          case '/drillRunner':
            return this.$.drillRunner;
          case '/drillCreator':
            return this.$.drillCreator;
          default:
            // Do not break each time we add a new page
            return undefined;
        }
      }
      
      _toggleDrawer() {
        this.$.drawer.toggle();
      }
      

      // 
      // Events (sychronize screens)
      //
      
      drillSessionRequested(e) {
        let detail = e.detail;
        this.$.drillRunner.reset();
        this.$.drillRunner.drill = undefined;
        this.$.drillRunner.drill = detail.drill;
        this.$.drillRunner.redirectUri = detail.redirectUri;
        this.goToDrillSession();
      }

    }

    window.customElements.define(TypioApp.is, TypioApp);
  </script>
</dom-module>
