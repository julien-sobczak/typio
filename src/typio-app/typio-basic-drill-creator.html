<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="/src/typio-app/typio-keyboard.html">
<link rel="import" href="/src/typio-app/shared-styles.html">

<dom-module id="typio-basic-drill-creator">
  <template>
    <style include="shared-styles">

      :host {
        display: block;
      }
      
      typio-keyboard {
        --typio-key-size: 0.50in;
      }
      
      ul.selection {
        height: 50px;
      }
      ul.selection li {
        list-style-type: none;
        display: inline-block;
        font-size: 26px;
      }
      ul.selection li.size-x-small .character { font-size: 0.8em; width: 30px; height: 30px; }
      ul.selection li.size-small   .character { font-size: 0.8em; width: 30px; height: 30px; }
      ul.selection li.size-medium  .character { font-size: 1em;   width: 35px; height: 35px; }
      ul.selection li.size-large   .character { font-size: 1.2em; width: 40px; height: 40px; }
      ul.selection li.size-x-large .character { font-size: 1.4em; width: 45px; height: 45px; }
      
      ul.selection li .character {
        display: inline-block;
        background-color: var(--typio-bg-color);
        color: white;
        border-radius: 50%;
        padding: 3px;
        margin-left: 5px;
        margin-right: 20px;
        text-align: center;
      }
      ul.selection li .count {
        font-size: 12px;
        color: white;
      }
      
      paper-input {
        --primary-text-color: var(--typio-bg-color);
        --secondary-text-color: white;
        --paper-input-container-color: white;
        --paper-input-container-focus-color: var(--typio-bg-color);
        
        width: 100%;
        margin: 0 auto;
      }
      
    </style>
    
    <paper-input id="input" label="Characters" value="{{characters}}" on-value-changed="_updateKeyboard">
      <iron-icon icon="hardware:keyboard" slot="prefix"></iron-icon>
    </paper-input>
    
    <!--
    <ul class="selection">
      <template is="dom-repeat" items="{{enteredKeys}}">
        <li class$="size-{{item.size}}">
          <span class="weight">{{item.count}}</span>
          <span class="character">{{item.character}}</span>          
        </li>
      </template>
    </ul>
    -->
    
    <typio-keyboard id="keyboard" mixed-cases clickable on-key-clicked="_registerClickedKey"></typio-keyboard>
    
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class TypioBasicDrillCreator extends Polymer.Element {
      static get is() { return 'typio-basic-drill-creator'; }
      static get properties() {
        return {
          
          /** 
           * Should we listen for key pressed?
           */
          listening: {
            type: Boolean,
            value: false
          },
          
          /**
           * List of characters pressed/clicked by the user.
           * 
           * Ex: { 'a' => 2, 'A' => 4, ... }
           */
          _enteredKeys: {
            type: Map,
            value: new Map()
          },
          
          /**
          * Same as `_enteredKeys` but as array.
           * 
           * Ex: [{'character': 'a', 'count'; 2}, ... }
           */
          enteredKeys: {
            type: Array,
            value: []
          },
          
          /**
           * Characters as entered by the user. The order is preserved.
           */
          characters: {
            type: String,
            value: "test"
          },
          
        };
      }
      
      ready() {
        super.ready();
        
        document.addEventListener('keypress', (event) => {
          if (!this.listening) return;
          
          // See https://developer.mozilla.org/fr/docs/Web/API/KeyboardEvent
          const keyName = event.key;
          const keyCode = event.code;
          const ctrlKey = event.ctrlKey;
          const shiftKey = event.shiftKey;
          const altKey = event.altKey;

          if (keyName === 'Control') {
            // not alert when only Control key is pressed.
            return;
          }

          if (event.ctrlKey) {
            // Even though event.key is not 'Control' (i.e. 'a' is pressed),
            // event.ctrlKey may be true if Ctrl key is pressed at the time.
            ;
          } else {
            this._registerPressedKey(keyName);
            event.preventDefault();
            return false;
          }

        }, false);
      }
      
      
      // 
      // State management
      //
      
      startListening() {
        this.listening = true;
      }
      stopListening() {
        this.listening = false;
      }
      
      
      //
      // Actions
      //
      
      _registerClickedKey(e, detail) {
        if (!this.listening) return;
        this._registerPressedKey(detail.character);
      }
      
      _registerPressedKey(character) {
        this.$.keyboard.pressKeys(character);
        let count = this._enteredKeys.get(character) || 0;
        this._enteredKeys.set(character, count + 1);
        
        // Determine maximum occurrence
        let maxCount = 0;
        this._enteredKeys.forEach((count, character) => {
          if (count > maxCount) maxCount = count;
        })
        
        // Calculate the array used by dom-repeat
        const sizes = ['x-small', 'small', 'medium', 'large', 'x-large'];
        let newEnteredKeys = [];
        this._enteredKeys.forEach((count, character) => {
          
          const size = Math.floor(count * 100 / maxCount / 20.1); // Should be between 0 and 4 inclusive 
          newEnteredKeys.push({
            'character': character,
            'count': count,
            'size': sizes[size]
          });
        });
        this.enteredKeys = newEnteredKeys;
      }
      
      _updateKeyboard() {
        console.log('Input changed', this.characters);
      }
    }

    window.customElements.define(TypioBasicDrillCreator.is, TypioBasicDrillCreator);
  </script>
</dom-module>
