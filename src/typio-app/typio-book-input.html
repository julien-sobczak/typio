<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/paper-range-slider/paper-range-slider.html">

<link rel="import" href="/src/typio-app/shared-styles.html">


<dom-module id="typio-book-input">
  <template>
    <style include="shared-styles">

      :host {
        display: block;
        width: 700px;
        padding: 20px;
        margin: 0 auto;
        text-align: left;
      }

      * {
        box-sizing: border-box;
      }

      ul {
        list-style-type: none;
      }

      li {
        border-top: 1px solid transparent;
        border-bottom: 1px solid transparent;
        padding-top: 15px;
        padding-bottom: 15px;
      }

      li .words {
        float: right;
        font-style: italic;
      }

      li iron-icon {
        margin-right: 15px;
      }

      li:hover {
        background-color: rgba(255, 255, 255, 0.2);
        border-top: 1px solid white;
        border-bottom: 1px solid white;
      }

      paper-range-slider {
        --paper-range-slider-width: 400px;
        --paper-range-slider-knob-color:              #2F3238;
        --paper-range-slider-pin-color:               #2F3238;
        --paper-range-slider-higher-color:            #2F3238;
        --paper-range-slider-lower-color:             #2F3238;
        --paper-range-slider-active-color:            #F06292;
        --paper-range-slider-knob-start-color:        #2F3238;
        --paper-range-slider-knob-start-border-color: #2F3238;

        margin: 0 auto;
        margin-top: 15px;
        margin-bottom: 15px;
        display: block;
      }
      .selection  {
        display: none;
        text-align: center;

        /* Add a trait to the left to connect chapters together */
        margin-left: 10px;
        border-left: 1px solid white;

      }
      li.selected .selection {
        display: block;
      }

    </style>

    <ul id="chapters">
      <template is="dom-repeat" items="{{metadata.chapters}}">
        <li>
          <iron-icon icon="av:library-books"></iron-icon>
          <a on-click="_chapterSelected">[[item.title]] <span class="words">[[item.words]] words</span></a>
          <div class="selection">
            <span class="words">[[item.words]] words</span>
            <paper-range-slider
                value-min="0"
                value-max="100"
                min="0"
                max="100">
            </paper-range-slider>
            <typio-button light on-click="_done">Select</typio-button>
          </div>
        </li>
      </template>
    </ul>

  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class TypioBookInput extends Polymer.Element {

      static get is() { return 'typio-book-input'; }
      static get properties() {
        return {
          /*
           * JSON representing the metadata of a given book.
           */
          metadata: {
            type: Object
          }

        };
      }

      _chapterSelected(e) {
        let index = e.model.index;

        this.chapterNumber = index + 1;
        this.chapter = this.metadata.chapters[index];
        this.startCharacter = 0;
        this.endCharacter = this.chapter.words;
        this.$.chapters.querySelectorAll('li').forEach(e => e.classList.remove('selected'));

        let li = this.$.chapters.querySelectorAll('li')[index];
        let slider = li.querySelector('paper-range-slider');
        let count = li.querySelector('.selection .words');

        li.classList.add('selected');
        slider.addEventListener('updateValues', e => {
          let rangeWords = parseInt(this.chapter.words * (slider.valueMax - slider.valueMin) / 100);
          this.startCharacter = parseInt(slider.valueMin * this.chapter.words / 100);
          this.endCharacter = parseInt(slider.valueMax * this.chapter.words / 100);
          count.innerHTML = rangeWords + ' words';
        });
      }

      _done() {
        let detail = {
          chapterNumber: this.chapterNumber,
          chapterTitle: this.chapter.title,
          startCharacter: this.startCharacter,
          endCharacter: this.endCharacter
        };
        this.dispatchEvent(new CustomEvent('chapter-selected', {detail: detail, bubbles: true, composed: true}));
      }

    }

    window.customElements.define(TypioBookInput.is, TypioBookInput);
  </script>
</dom-module>
