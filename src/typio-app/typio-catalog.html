<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="/src/typio-app/shared-styles.html">
<link rel="import" href="/src/typio-app/typio-button.html">
<link rel="import" href="/src/typio-app/typio-code-editor.html">
<link rel="import" href="/src/typio-app/typio-collapsable-radio-group.html">

<dom-module id="typio-catalog">
  <template>
    <style include="shared-styles">

      :host {
        display: block;
      }
      
      * {
        box-sizing: border-box;
      }

      section {
        width: 100%;
        display: table;
        margin: 0;
        max-width: none;
        height: 100vh;
        position: relative;

        padding: 50px;
        color: white;
        text-align: center;
        transition: background-color 1s linear;
      }

      section.type-code {
        background-color: #009ee3;
      }
      section.type-literature {
        background-color: #e3004f;
      }

      section .content {
        display: table-cell;
        vertical-align: middle;
      }



      /*
       * Buttons
       */

      .buttons {
        position: absolute;
        width: 100%;
        bottom: 10vh;
        text-align: center;
      }
      #intro .buttons {
        opacity: 0;
        transition: opacity 2s linear;
      }
      #intro.completed .buttons {
        opacity: 1;
      }
      typio-button {
        display: inline-block;
      }


      h3 {
        text-align: center;
        font-size: 2em;
        margin-bottom: 50px;
      }
      paper-tabs {
        text-align: center;
        width: 300px;
        margin: 0 auto;
      }

      .type {
        padding: 20px 20px 40px;
        margin-left: 25px;
        margin-right: 25px;
      }

      /* Manage the content selection workflow */
      .type .step {
        display: none;
      }
      .type.step1 .step1 { display: block; }
      .type.step2 .step2 { display: block; }
      .type.step3 .step3 { display: block; }
      .type.step4 .step4 { display: block; }


      /* Selection */
      .selection {
        visibility: hidden;
        margin-top: 20px;
        margin-bottom: 20px;
      }
      .type.step2 .selection,
      .type.step3 .selection,
      .type.step4 .selection {
        visibility: visible;
      }
      .selection .entry {
        display: none;
        position: relative;
        font-size: 90%;
        padding: 10px 20px;
        padding-right: 0px;
        background: rgba(0, 0, 0, 0.5);
        margin-right: 20px;
      }
      .type.step2 .selection .entry:nth-child(1) { display: inline-block; }
      .type.step3 .selection .entry:nth-child(1) { display: inline-block; }
      .type.step3 .selection .entry:nth-child(2) { display: inline-block; }

      .selection .entry iron-icon {
        margin-left: 20px;
      }

    </style>

    <iron-ajax url="/dataset.json" auto last-response="{{catalog}}"></iron-ajax>

    <section id="catalog">
      <h3>Practice</h3>

      <paper-tabs id="typeTabs" attr-for-selected="data-type" selected="[[type]]" on-iron-select="_changedType">
        <paper-tab data-type="code">Code</paper-tab>
        <paper-tab data-type="literature">Literature</paper-tab>
      </paper-tabs>

      <div id="typeCode" class$="type type-code step[[stepCode]]" data-step="1">

        <div class="selection">
            <div class="entry">
              <a on-click="_goToTypeCodeStep1">
                [[selectedProgrammingLanguage]]
                <iron-icon icon="backspace"></iron-icon>
              </a>
            </div>
            <div class="entry">
              <a on-click="_goToTypeCodeStep2">
                [[selectedProject]]
                <iron-icon icon="backspace"></iron-icon>
              </a>
            </div>
        </div>

        <div id="typeCodeStep1" class="step step1">
          <typio-collapsable-radio-group id="programmingLanguages"
              elements="{{programmingLanguages}}"
              on-paper-radio-group-changed="_programmingLanguageSelected"
              show-description="true">
          </typio-collapsable-radio-group>
        </div>

        <div id="typeCodeStep2" class="step step2">
          <typio-collapsable-radio-group id="projects"
              elements="{{projects}}"
              on-paper-radio-group-changed="_projectSelected"
              show-description="true"
              layout="medium">
          </typio-collapsable-radio-group>
        </div>

        <div id="typeCodeStep3" class="step step3">
          ici
        </div>

      </div>

      <div id="typeLiterature" class$="type type-literature step[[stepLiterature]]">

        <div id="typeLiteratureStep1" class="step step1">
          <typio-collapsable-radio-group id="spokenLanguages"
              elements="{{spokenLanguages}}"
              on-paper-radio-group-changed="_spokenLanguageSelected"
              show-description="true">
          </typio-collapsable-radio-group>
        </div>

        <div id="typeLiteratureStep2" class="step step2">
          <typio-collapsable-radio-group id="books"
              elements="{{books}}"
              on-paper-radio-group-changed="_bookSelected"
              show-description="true"
              layout="large">
          </typio-collapsable-radio-group>
        </div>

        <div id="typeLiteratureStep3" class="step step3">

        </div>

      </div>

      <div class="buttons">
        <a href="/#catalog"><typio-button light>Go!</typio-button></a>
      </div>

    </section>

  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class TypioCatalog extends Polymer.Element {

      static get is() { return 'typio-catalog'; }
      static get properties() {
        return {
          /*
           * JSON representing the file `/dataset.json`.
           */
          catalog: {
            type: Object,
            observer: '_onLoadCatalog'
          },

          /*
           * Which type is selected (Code, Literature, ...)
           */
          type: {
            type: String,
            value: 'code'
          },

          /*
           * Current step in the code selection workflow.
           */
          stepCode: {
            type: Number,
            value: 1
          },

          /*
           * Current step in the literature selection workflow.
           */
          stepLiterature: {
            type: Number,
            value: 1
          },

          /*
           * Sorted list of programming languages present in `catalog`.
           */
          programmingLanguages: {
            type: Array,
            value: []
          },

          /*
           * The selected language among the 'programmingLanguages' list
           */
          selectedProgrammingLanguage: {
            type: String
          },

          /*
           * Sorted list of Github projects present in `catalog`.
           */
          projects: {
            type: Array,
            value: []
          },

          /*
           * The selected project among the 'projects' list
           */
          selectedProject: {
            type: String
          },

          /*
           * Sorted list of spoken languages present in `catalog`.
           */
          spokenLanguages: {
            type: Array,
            value: []
          },

          /*
           * The selected language among the 'spokenLanguages' list
           */
          selectedSpokenLanguage: {
            type: String
          },

          /*
           * Sorted list of books present in `catalog`.
           */
          books: {
            type: Array,
            value: []
          },

          /*
           * The selected book among the 'books' list
           */
          selectedBook: {
            type: String
          }

        };
      }

      _onLoadCatalog() {
        if (!this.catalog) return;

        let newProgrammingLanguages = new Array();
        let newSpokenLanguages = new Array();

        this.catalog.forEach(entry => {

          if (entry.origin === 'github') {
            let found = false;
            for (let i = 0; i < newProgrammingLanguages.length; i++) {
              if (newProgrammingLanguages[i].key == entry.language) {
                let programmingLanguage = newProgrammingLanguages[i];
                found = true;
                programmingLanguage.count++;
                programmingLanguage.description = programmingLanguage.count + ' projects';
                break;
              }
            }
            if (!found) {
              newProgrammingLanguages.push({
                'key': entry.language,
                'name': entry.language,
                'count': 1,
                'description': '1 project'
              });
            }
          }

          if (entry.origin === 'gutenberg') {
            let found = false;
            for (let i = 0; i < newSpokenLanguages.length; i++) {
              let spokenLanguage = newSpokenLanguages[i];
              if (spokenLanguage.key == entry.language) {
                found = true;
                spokenLanguage.count++;
                spokenLanguage.description = spokenLanguage.count + ' books';
                break;
              }
            }
            if (!found) {
              newSpokenLanguages.push({
                'key': entry.language,
                'name': entry.language,
                'count': 1,
                'description': '1 book'
              });
            }
          }
        });

        this.programmingLanguages = newProgrammingLanguages.sort((a,b) => a.count > b.count ? -1 : a.count < b.count ? 1 : 0);
        this.spokenLanguages = newSpokenLanguages.sort((a,b) => a.count > b.count ? -1 : a.count < b.count ? 1 : 0);
      }

      /* Tabs */

      _changedType(e) {
        this.type = this.$.typeTabs.selected;
        this.$.catalog.classList.remove('type-code', 'type-literature');
        this.$.catalog.classList.add('type-' + this.type);
        this.$.typeCode.style.display = this.type === 'code' ? "block" : "none";
        this.$.typeLiterature.style.display = this.type === 'literature' ? "block" : "none";
      }


      /* Tab Code */

      _programmingLanguageSelected(value) {
        this.selectedProgrammingLanguage = this.$.programmingLanguages.selected;

        // Search Github projects matching the selected language
        let newProjects = new Array();
        this.catalog.forEach(entry => {
          if (entry.origin === 'github' && entry.language == this.selectedProgrammingLanguage) {
            newProjects.push({
              'key': entry.name,
              'name': entry.name,
              'description': entry.url.replace('https://github.com/', '')
            });
          }
        });
        // Sort by project name
        this.projects = newProjects.sort((a,b) => a.name.localeCompare(b.name));

        this.stepCode = 2;
      }

      _projectSelected(value) {
        this.selectedProject = this.$.projects.selected;

        // TODO load book metadata

        this.stepCode = 3;
      }

      /* Tab Literature */

      _spokenLanguageSelected(value) {
        this.selectedSpokenLanguage = this.$.spokenLanguages.selected;

        // Search gutenberg books matching the selected language
        let newBooks = new Array();
        this.catalog.forEach(entry => {
          if (entry.origin === 'gutenberg' && entry.language == this.selectedSpokenLanguage) {
            newBooks.push({
              'key': entry.title,
              'name': entry.title,
              'description': entry.author
            });
          }
        });
        // Sort by book title
        this.books = newBooks.sort((a,b) => a.name.localeCompare(b.name));

        this.stepLiterature = 2;
      }

      _bookSelected(value) {
        this.selectedBook = this.$.books.selected;

        // TODO load book metadata

        this.stepCode = 3;
      }

      _goToTypeCodeStep1() {
        this._resetProgrammingLanguage();
        this._resetProject();
        this.stepCode = 1;
      }
      _goToTypeCodeStep2() {
        this._resetProject();
        this.stepCode = 2;
      }

      _resetProgrammingLanguage() {
        this.selectedProgrammingLanguage = null;
        this.$.programmingLanguages.selected = null;
      }
      _resetProject() {
        this.selectedProject = null;
        this.$.projects.selected = null;
      }

    }

    window.customElements.define(TypioCatalog.is, TypioCatalog);
  </script>
</dom-module>
