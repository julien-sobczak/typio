<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="/src/typio-app/shared-styles.html">
<link rel="import" href="/src/typio-app/typio-button.html">
<link rel="import" href="/src/typio-app/typio-collapsable-radio-group.html">
<link rel="import" href="/src/typio-app/typio-project-input.html">
<link rel="import" href="/src/typio-app/typio-book-input.html">
<link rel="import" href="/src/typio-app/typio-loader.html">

<dom-module id="typio-catalog">
  <template>
    <style include="shared-styles">

      section {
        padding: 50px;
        color: white;
        text-align: center;
        transition: background-color 1s linear;
      }

      section .content {
        display: table-cell;
        vertical-align: middle;
      }

      section.type-code {
        background-color: #009ee3;
      }
      section.type-literature {
        background-color: #009ee3;
        /*background-color: #e3004f;*/ 
        /* TODO see if pertinent */
      }

      section .content {
        display: table-cell;
        vertical-align: middle;
      }

      /* TODO extract into typio-notice-text */
      .notice {
        font-size: 2em;
        font-weight: bold;
        animation: blink-animation 2.4s linear infinite;
      }
      .notice b {
        font-style: italic;
        font-weight: normal;
      }
      @keyframes blink-animation {
        0%, 30% { opacity: 100; }
        50% { opacity: 0; }
        70%, 100% { opacity: 100; }
      }

      /*
       * Buttons
       */

      .buttons {
        position: absolute;
        width: 100%;
        bottom: 10vh;
        text-align: center;
      }
      #intro .buttons {
        opacity: 0;
        transition: opacity 2s linear;
      }
      #intro.completed .buttons {
        opacity: 1;
      }
      typio-button {
        display: inline-block;
      }


      h3 {
        text-align: center;
        font-size: 2em;
        margin-bottom: 50px;
      }
      paper-tabs {
        text-align: center;
        width: 300px;
        margin: 0 auto;
      }

      .type {
        padding: 20px 20px 40px;
        margin-left: 25px;
        margin-right: 25px;
      }

      /* Manage the content selection workflow */
      .type .step {
        display: none;
      }
      .type.step0 .step0 { display: block; }
      .type.step1 .step1 { display: block; }
      .type.step2 .step2 { display: block; }
      .type.step3 .step3 { display: block; }
      .type.step4 .step4 { display: block; }


      /* Selection */
      .selection {
        visibility: hidden;
        margin-top: 20px;
        margin-bottom: 20px;
      }

      .type.step2 .selection,
      .type.step3 .selection,
      .type.step4 .selection {
        visibility: visible;
      }
      .selection .entry {
        display: none;
        position: relative;
        font-size: 90%;
        padding: 10px 20px;
        padding-right: 0px;
        background: rgba(0, 0, 0, 0.5);
        margin-right: 20px;
      }
      .type.step2 .selection .entry:nth-child(1) { display: inline-block; }
      .type.step3 .selection .entry:nth-child(1) { display: inline-block; }
      .type.step3 .selection .entry:nth-child(2) { display: inline-block; }

      .selection .entry iron-icon {
        margin-left: 20px;
        margin-right: 20px;
      }
      
      #surpriseMe {
        position: absolute;
        bottom: 0;
        left: 50%;
        height: 70px;
        width: 200px;
        margin-left: -100px;
        padding-top: 25px;
        border-top-left-radius: 200px;
        border-top-right-radius: 200px;
        background-color: rgba(0, 0, 0, 0.5);
      }

    </style>

    <iron-ajax url="/catalog.json" auto last-response="{{catalog}}"></iron-ajax>
    <iron-ajax auto url="{{_urlMetadata}}" handle-as="json" on-response="_onMetadataLoaded"></iron-ajax>
    <iron-ajax auto url="{{_urlContent}}" handle-as="text" on-response="_onContentLoaded"></iron-ajax>
    <iron-ajax auto url="{{_urlMetadataSurprise}}" handle-as="json" on-response="_onMetadataSurpriseLoaded"></iron-ajax>

    <section id="catalog">
      <h3>Practice</h3>

      <paper-tabs id="typeTabs" attr-for-selected="data-type" selected="[[type]]" on-iron-select="_changedType">
        <paper-tab data-type="code">Code</paper-tab>
        <paper-tab data-type="literature">Literature</paper-tab>
      </paper-tabs>

      <div id="typeCode" class$="type type-code step[[stepCode]]" data-step="1">

        <div class="selection">
          <div class="entry">
            <a on-click="_goToTypeCodeStep1">
              [[selectedProgrammingLanguage]]
              <iron-icon icon="backspace"></iron-icon>
            </a>
          </div>
          <div class="entry">
            <a on-click="_goToTypeCodeStep2">
              [[selectedProject]]
              <iron-icon icon="backspace"></iron-icon>
            </a>
          </div>
        </div>

        <div class="step step1">
          <typio-collapsable-radio-group id="programmingLanguages"
              elements="{{programmingLanguages}}"
              on-paper-radio-group-changed="_programmingLanguageSelected"
              show-description="true">
          </typio-collapsable-radio-group>
        </div>

        <div class="step step2">
          <typio-collapsable-radio-group id="projects"
              elements="{{projects}}"
              on-paper-radio-group-changed="_projectSelected"
              show-description="true"
              layout="medium">
          </typio-collapsable-radio-group>
        </div>

        <div class="step step3">
          <typio-project-input id="project"
              metadata="{{projectMetadata}}"
              on-file-selected="_fileSelected">
        </div>

        <div class="step step4">
          <p class="notice">Downloading the file <b>[[selectedFilename]]</b>...</p>
        </div>

      </div>

      <div id="typeLiterature" class$="type type-literature step[[stepLiterature]]">


        <div class="selection">
          <div class="entry">
            <a on-click="_goToTypeLiteratureStep1">
              [[selectedSpokenLanguage]]
              <iron-icon icon="backspace"></iron-icon>
            </a>
          </div>
          <div class="entry">
            <a on-click="_goToTypeLiteratureStep2">
              [[selectedBook]]
              <iron-icon icon="backspace"></iron-icon>
            </a>
          </div>
        </div>

        <div class="step step1">
          <typio-collapsable-radio-group id="spokenLanguages"
              elements="{{spokenLanguages}}"
              on-paper-radio-group-changed="_spokenLanguageSelected"
              show-description="true">
          </typio-collapsable-radio-group>
        </div>

        <div class="step step2">
          <typio-collapsable-radio-group id="books"
              elements="{{books}}"
              on-paper-radio-group-changed="_bookSelected"
              show-description="true"
              layout="large">
          </typio-collapsable-radio-group>
        </div>

        <div class="step step3">
          <typio-book-input id="book"
              metadata="{{bookMetadata}}"
              on-chapter-selected="_chapterSelected">
          </typio-book-input>
        </div>

        <div class="step step4">
          <p class="notice">Downloading the book <b>[[selectedBook]]</b>...</p>
        </div>
        
      </div>
      
      <div id="surpriseMe">
        <a on-click="_surpriseMe">Surprise Me!</a>
      </div>

      <template is="dom-if" if="{{isLoading}}">
        <typio-loader></typio-loader>
      </template>

    </section>

  </template>

  <script>
  
    function getRandomInt(max) {
      return Math.floor(Math.random() * Math.floor(max));
    }
  
    /**
     * Catalog screen. 
     * 
     * Let the user select the text to touch type from a list of ressources.
     *
     * @event entry-selected fired after the user has made his choice and 
     *                       the content to touch type is loaded.
     * @customElement
     * @polymer
     */
    class TypioCatalog extends Polymer.Element {

      static get is() { return 'typio-catalog'; }
      static get properties() {
        return {
          /**
           * JSON representing the file `/catalog.json`.
           */
          catalog: {
            type: Object,
            observer: '_onLoadCatalog'
          },

          /**
           * Which type is selected (Code, Literature, ...)
           */
          type: {
            type: String,
            value: 'code'
          },

          /**
           * Current step in the code selection workflow.
           */
          stepCode: {
            type: Number,
            value: 1
          },

          /**
           * Current step in the literature selection workflow.
           */
          stepLiterature: {
            type: Number,
            value: 1
          },

          /**
           * Sorted list of programming languages present in `catalog`.
           */
          programmingLanguages: {
            type: Array,
            value: []
          },

          /**
           * The selected language among the 'programmingLanguages' list
           */
          selectedProgrammingLanguage: {
            type: String
          },

          /**
           * Sorted list of Github projects present in `catalog`.
           */
          projects: {
            type: Array,
            value: []
          },

          /**
           * The selected project among the 'projects' list
           */
          selectedProject: {
            type: String
          },

          /**
           * Sorted list of spoken languages present in `catalog`.
           */
          spokenLanguages: {
            type: Array,
            value: []
          },

          /**
           * The selected language among the 'spokenLanguages' list
           */
          selectedSpokenLanguage: {
            type: String
          },

          /**
           * Sorted list of books present in `catalog`.
           */
          books: {
            type: Array,
            value: []
          },

          /**
           * The selected book among the 'books' list
           */
          selectedBook: {
            type: String
          },

          /**
           * URL to download the metadata of a given ressource.
           */
          _urlMetadata: {
            type: String,
            value: null
          },
          
          /**
           * URL to download the metadata when using the "Surprise Me".
           */
          _urlMetadataSurprise: {
            type: String,
            value: null
          },

          /**
           * URL to download the content of a given ressource.
           */
          _urlContent: {
            type: String,
            value: null
          },

          /**
           * JSON describing a Github project.
           *
           * @see /content/github/*.json for examples.
           */
          projectMetadata: {
            type: Object,
            value: null // will be loaded once the user select a Github project
          },

          /**
           * JSON describing a Gutenberg book.
           *
           * @see /content/gutenberg/*.json for examples.
           */
          bookMetadata: {
            type: Object,
            value: null // will be loaded once the user select a Gutenberg book
          }

        };
      }

      /** 
       * Called when the `catalog.json` has finished loaded.
       */
      _onLoadCatalog() {
        if (!this.catalog) return;

        let newProgrammingLanguages = new Array();
        let newSpokenLanguages = new Array();

        // Traverse the catalog to populate lists.
        this.catalog.forEach(entry => {

          if (entry.active === false) return;

          if (entry.origin === 'github') {
            let found = false;
            for (let i = 0; i < newProgrammingLanguages.length; i++) {
              if (newProgrammingLanguages[i].key == entry.language) {
                let programmingLanguage = newProgrammingLanguages[i];
                found = true;
                programmingLanguage.count++;
                programmingLanguage.description = programmingLanguage.count + ' projects';
                break;
              }
            }
            if (!found) {
              newProgrammingLanguages.push({
                'key': entry.language,
                'name': entry.language,
                'count': 1,
                'description': '1 project'
              });
            }
          }

          if (entry.origin === 'gutenberg') {
            let found = false;
            for (let i = 0; i < newSpokenLanguages.length; i++) {
              let spokenLanguage = newSpokenLanguages[i];
              if (spokenLanguage.key == entry.language) {
                found = true;
                spokenLanguage.count++;
                spokenLanguage.description = spokenLanguage.count + ' books';
                break;
              }
            }
            if (!found) {
              newSpokenLanguages.push({
                'key': entry.language,
                'name': entry.language,
                'count': 1,
                'description': '1 book'
              });
            }
          }
        });

        this.programmingLanguages = newProgrammingLanguages.sort((a,b) => a.count > b.count ? -1 : a.count < b.count ? 1 : 0);
        this.spokenLanguages = newSpokenLanguages.sort((a,b) => a.count > b.count ? -1 : a.count < b.count ? 1 : 0);
      }

      /* Tabs */

      /**
       * Called when the user changed the type of ressource.
       */
      _changedType(e) {
        this.type = this.$.typeTabs.selected;
        this.$.catalog.classList.remove('type-code', 'type-literature');
        this.$.catalog.classList.add('type-' + this.type);
        this.$.typeCode.style.display = this.type === 'code' ? "block" : "none";
        this.$.typeLiterature.style.display = this.type === 'literature' ? "block" : "none";
      }


      /* Tab Code */

      /**
       * Called when the user selects a programming language.
       */
      _programmingLanguageSelected(value) {
        this.selectedProgrammingLanguage = this.$.programmingLanguages.selected;
        this.projects = this._getProjects(this.selectedProgrammingLanguage);
        this.stepCode = 2;
      }
      
      _getProjects(programmingLanguage) {
        // Search Github projects matching the selected language
        let projects = new Array();
        this.catalog.forEach(entry => {
          
          if (entry.active === false) return;
          
          if (entry.origin === 'github' && entry.language == programmingLanguage) {
            projects.push({
              'key': entry.name,
              'name': entry.name,
              'description': entry.url.replace('https://github.com/', '')
            });
          }
        });
        // Sort by project name
        return projects.sort((a,b) => a.name.localeCompare(b.name));
      }

      /**
       * Called when the user selects a project.
       */
      _projectSelected(value) {
        this.selectedProject = this.$.projects.selected;

        this.catalog.forEach(entry => {
          if (entry.origin === 'github' && entry.name == this.selectedProject) {
            let [organization, project] = entry.url.replace('https://github.com/', '').split('/')
            let commit = entry.commit
            let slug = entry.slug ? entry.slug : this._slug(organization + '_' + project + '_' + commit);
            this._urlMetadata = '/content/github/' + slug + '.json'
            this.isLoading = true;
          }
        });

      }

      /* Tab Literature */

      /**
       * Called when the user select a spoken language.
       */
      _spokenLanguageSelected(value) {
        this.selectedSpokenLanguage = this.$.spokenLanguages.selected;
        this.books = this._getBooks(this.selectedSpokenLanguage);
        this.stepLiterature = 2;
      }
      
      _getBooks(spokenLanguage) {
        // Search gutenberg books matching the selected language
        let books = new Array();
        this.catalog.forEach(entry => {
          
          if (entry.active === false) return;
          
          if (entry.origin === 'gutenberg' && entry.language == spokenLanguage) {
            books.push({
              'key': entry.title,
              'name': entry.title,
              'description': entry.author
            });
          }
        });
        // Sort by book title
        return books.sort((a,b) => a.name.localeCompare(b.name));
      }

      /**
       * Called when the user selects a book.
       */
      _bookSelected(value) {
        this.selectedBook = this.$.books.selected;

        this.catalog.forEach(entry => {
          if (entry.origin === 'gutenberg' && entry.title == this.selectedBook) {
            let slug = entry.slug ? entry.slug : this._slug(entry.title);
            this._urlMetadata = '/content/gutenberg/' + slug + '.json'
            this.isLoading = true;
          }
        });
      }

      /* Fallback when the attribut 'slug' is not defined in 'catalog.json' */      
      _slug(text) {
        let slug = text.replace(/\s/g, '-').replace(/'/g, '');
        return slug;
      }

      /*
       * Move between the workflow.
       */

      _goToTypeCodeStep1() {
        this._resetProgrammingLanguage();
        this._resetProject();
        this.stepCode = 1;
      }
      _goToTypeCodeStep2() {
        this._resetProject();
        this.stepCode = 2;
      }
      _goToTypeLiteratureStep1() {
        this._resetSpokenLanguage();
        this._resetBook();
        this.stepLiterature = 1;
      }
      _goToTypeLiteratureStep2() {
        this._resetBook();
        this.stepLiterature = 2;
      }

      _resetProgrammingLanguage() {
        this.selectedProgrammingLanguage = null;
        this.$.programmingLanguages.selected = null;
      }
      _resetProject() {
        this.selectedProject = null;
        this.$.projects.selected = null;
      }
      _resetSpokenLanguage() {
        this.selectedSpokenLanguage = null;
        this.$.spokenLanguages.selected = null;
      }
      _resetBook() {
        this.selectedBook = null;
        this.$.books.selected = null;
      }

      /* Metadata */
      _onMetadataLoaded(e, data) {
        const metadata = data.response;
        this.isLoading = false;
        if (this.type === 'code') {
          this.projectMetadata = metadata;
          this.stepCode = 3;
        } else if (this.type === 'literature') {
          this.bookMetadata = metadata;
          this.stepLiterature = 3;
        }
      }

      _chapterSelected(e) {
        let d = e.detail;
        this.selectChapter(d.chapterTitle, d.startLine, d.endLine);
      }
      
      selectChapter(chapterTitle, startLine, endLine) {
        this.selectedChapter = chapterTitle;
        this.startLine = startLine;
        this.endLine = endLine;

        this.catalog.forEach(entry => {
          if (entry.origin === 'gutenberg' && entry.title == this.selectedBook) {
            let slug = entry.slug ? entry.slug : this._slug(entry.title);
            this._urlContent = '/content/gutenberg/' + slug + '.txt'
            this.isLoading = true;
            this.stepLiterature = 4;
            console.log('[typio-catalog] selectChapter ' + this.selectedBook + '...');
          }
        });
      }

      _fileSelected(e) {
        let d = e.detail;
        this.selectFile(d.filepath, d.filename, d.extension);
      }
      
      selectFile(filepath, filename, extension) {
        this.selectedFile = filepath;
        this.selectedFilename = filename;
        this.selectedFileExtension = extension;
        this.selectedRealProgrammingLanguage = LANGUAGE_PER_EXTENSIONS.has(this.selectedFileExtension) ?
          LANGUAGE_PER_EXTENSIONS.get(this.selectedFileExtension) : 'undefined';

        this.catalog.forEach(entry => {
          if (entry.origin === 'github' && entry.name == this.selectedProject) {
            let organizationProject = entry.url.replace('https://github.com/', '');
            let [organization, project] = entry.url.replace('https://github.com/', '').split('/');
            let commit = entry.commit;
            let slug = entry.slug ? entry.slug : this._slug(organization + '_' + project + '_' + commit);
            let url = '/content/github/' + slug + '/' + this.selectedFile;
            
            // To retrieve from GitHub
            // Ex: https://raw.githubusercontent.com/apache/flume/trunk/flume-ng-clients/pom.xml
            //let url = 'https://raw.githubusercontent.com/' + organizationProject + '/' + entry.commit + '/' + this.selectedFile;
            
            console.log('[typio-catalog] loading ' + url);
            this._urlContent = url;
            this.isLoading = true;
            this.stepCode = 4;
            console.log('[typio-catalog] selectFile ' + this.selectedFile + '...');
          }
        });
      }

      /**
       * Called when the selected content has finished loaded.
       */
      _onContentLoaded(e, data) {
        const content = data.response;
        this.isLoading = false;

        if (this.type === 'code') {
          this.stepCode = 3;

          let detail = {
            type: 'code',
            language: this.selectedRealProgrammingLanguage,
            resource: this.selectedProject,
            resourceItem: this.selectedFile,
            content: content
          };
          this.dispatchEvent(new CustomEvent('entry-selected', {detail: detail, bubbles: true, composed: true}));

        } else if (this.type === 'literature') {
          this.stepLiterature = 3;

          let detail = {
            type: 'literature',
            language: this.selectedSpokenLanguage,
            resource: this.selectedBook,
            resourceItem: this.selectedChapter,
            content: content.split('\n').slice(this.startLine - 1, this.endLine).join('\n')
          };
          this.dispatchEvent(new CustomEvent('entry-selected', {detail: detail, bubbles: true, composed: true}));
        }

      }
      
      /**
       * Traverse the catalog matching already selected criteria to find a resource 
       * (a file, a chapter, ...).
       */
      _surpriseMe() {
        // Determine the type
        if (!this.type) {
          const TYPES = ['code', 'literature'];
          this.type = TYPES[getRandomInt(TYPES.length)];
        }
        
        // Resources differ along the type
        if (this.type === 'code') {
          
          // We need to determine a source file
          
          if (!this.selectedProgrammingLanguage) {
            this.selectedProgrammingLanguage = this.programmingLanguages[getRandomInt(this.programmingLanguages.length)].name;
          }
          
          if (!this.selectedProject) {
            let projects = this._getProjects(this.selectedProgrammingLanguage);
            this.selectedProject = projects[getRandomInt(projects.length)].name;
          }         
          
          console.log('[typio-catalog] Using randomly selected project ' + this.selectedProject + ' (' + this.selectedProgrammingLanguage + ')');           
          
          // Retrieve the project JSON file to select a file randomly
          this.catalog.forEach(entry => {
            if (entry.origin === 'github' && entry.name == this.selectedProject) {
              let [organization, project] = entry.url.replace('https://github.com/', '').split('/')
              let commit = entry.commit
              let slug = entry.slug ? entry.slug : this._slug(organization + '_' + project + '_' + commit);
              this._urlMetadataSurprise = '/content/github/' + slug + '.json'
              this.isLoading = true;
            }
          });
          
          
        } else if (this.type === 'literature') {
          
          // We need to determine a chapter excerpt
          
          if (!this.selectedSpokenLanguage) {
            this.selectedSpokenLanguage = this.spokenLanguages[getRandomInt(this.spokenLanguages.length)].name;
          }
          
          if (!this.selectedBook) {
            let books = this._getBooks(this.selectedSpokenLanguage);
            this.selectedBook = books[getRandomInt(books.length)].name;
          }
          
          console.log('[typio-catalog] Using randomly selected book ' + this.selectedBook + ' (' + this.selectedSpokenLanguage + ')');
          
          // Retrieve the book JSON file to select a chapter randomly
          this.catalog.forEach(entry => {
            if (entry.origin === 'gutenberg' && entry.title == this.selectedBook) {
              let slug = entry.slug ? entry.slug : this._slug(entry.title);
              this._urlMetadataSurprise = '/content/gutenberg/' + slug + '.json'
              this.isLoading = true;
            }
          });
          
        }
        
      }
      
      /**
       * Metadata (only when using the SurpriseMe button).
       *
       * Select randomly an entry in the metadata file.
       */
      _onMetadataSurpriseLoaded(e, data) {
        const metadata = data.response;
        this.isLoading = false;
        console.log('[typio-catalog] _onMetadataSurpriseLoaded');
        if (this.type === 'code') {
          this.projectMetadata = metadata;
          let file = this.projectMetadata.files[getRandomInt(this.projectMetadata.files.length)];
          let filename = file.path.split('/').reverse()[0];
          this.selectFile(file.path, filename, file.extension);
        } else if (this.type === 'literature') {
          this.bookMetadata = metadata;
          let chapter = this.bookMetadata.chapters[getRandomInt(this.bookMetadata.chapters.length)];
          const numberLines = 100;
          let start = Math.max(0, getRandomInt(chapter.end - numberLines));
          this.selectChapter(chapter.title, start, start + numberLines); 
        }
      }

    }

    window.customElements.define(TypioCatalog.is, TypioCatalog);
  </script>
</dom-module>
