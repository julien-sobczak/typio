<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="/src/typio-app/shared-styles.html">
<link rel="import" href="/src/typio-app/typio-button.html">
<link rel="import" href="/src/typio-app/typio-code-editor.html">

<dom-module id="typio-catalog">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      * {
        box-sizing: border-box;
      }

      section {
        width: 100%;
        display: table;
        margin: 0;
        max-width: none;
        height: 100vh;
        position: relative;

        background-color: #009ee3;
        padding: 50px;
        color: white;
        text-align: center;
      }

      section .content {
        display: table-cell;
        vertical-align: middle;
      }


       /*
        * Buttons
        */

       .buttons {
         position: absolute;
         width: 100%;
         bottom: 10vh;
         text-align: center;

       }
       #intro .buttons {
         opacity: 0;
         transition: opacity 2s linear;
       }
       #intro.completed .buttons {
         opacity: 1;
       }
       typio-button {
         display: inline-block;
       }


       h3 {
         text-align: center;
         font-size: 2em;
         margin-bottom: 50px;
       }
       paper-tabs {
         text-align: center;
         width: 300px;
         margin: 0 auto;
       }
       .type {
         padding: 20px 20px 40px;
         margin-left: 25px;
         margin-right: 25px;
       }
       .count {
         display: inline-block;
         text-align: center;
         color: white;
         background-color: rgba(0, 0, 0, 0.5);
         border-radius: 4px;
         font-size: 0.7em;
         padding: 0.3em 0.4em;
         margin-top: 5px;
       }

       paper-radio-group {
         display: inline;
       }
       .type a {
         margin: 25px;
         font-weight: bold;
         font-size: 110%;
         color: white !important;
       }
       .type a iron-icon {
         margin-right: 10px;
       }
       .type paper-radio-button, .type a {
         text-align: left;
         width: 115px;
         font-size: 14px;
         margin: 10px 10px;
       }
       paper-radio-group paper-radio-button {
         background-color: rgba(255, 255, 255, 0.2);
       }
       paper-radio-button:hover {
         background-color: rgba(0, 0, 0, 0.2);
       }

    </style>

    <iron-ajax url="/dataset.json" auto last-response="{{catalog}}"></iron-ajax>

    <section>
      <h3>Practice</h3>

      <paper-tabs id="typeTabs" attr-for-selected="data-type" selected="[[type]]" on-iron-select="_changedType">
        <paper-tab data-type="code">Code</paper-tab>
        <paper-tab data-type="literature">Literature</paper-tab>
      </paper-tabs>

      <div id="typeCode" class="type type-code" data-step="1">

        <div id="typeCodeStep1">
          <paper-radio-group>
          <template id="programmingLanguagesList" is="dom-repeat" items="{{programmingLanguages}}" filter="_filterProjects">
            <paper-radio-button class="catalog-entry" name="[[item.0]]">[[item.0]] <br><span class="count">[[item.1]] projects</span></paper-radio-button>
          </template>
          </paper-radio-group>
          <template is="dom-if" if="{{showAllProgrammingLanguages}}">
            <a on-click="_unselectAllProgrammingLanguages">
              <iron-icon icon="remove-circle"></iron-icon> Less
            </a>
          </template>
          <template is="dom-if" id="typeLiterature" if="{{!showAllProgrammingLanguages}}">
            <a on-click="_selectAllProgrammingLanguages">
              <iron-icon icon="add-circle"></iron-icon> More
            </a>
          </template>
        </div>

        <div id="typeCodeStep2">
        </div>

      </div>

      <div id="typeLiterature" class="type type-roman">
        <paper-radio-group>
        <template is="dom-repeat" items="{{spokenLanguages}}">
          <paper-radio-button class="catalog-entry" name="[[item.0]]">[[item.0]] <br><span class="count">[[item.1]] books</span></paper-radio-button>
        </template>
        </paper-radio-group>
      </div>

      <div class="buttons">
        <a href="/#catalog"><typio-button light>Go!</typio-button></a>
      </div>

    </section>

  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class TypioCatalog extends Polymer.Element {
      static get is() { return 'typio-catalog'; }
      static get properties() {
        return {
          /*
           * JSON representing the file `/dataset.json`.
           */
          catalog: {
            type: Object,
            observer: '_onLoadCatalog'
          },

          type: {
            type: String,
            value: 'code'
          },

          /*
           * Sorted list of programming languages present in `catalog`.
           */
          programmingLanguages: {
            type: Array,
            value: []
          },

          /*
           * Sorted list of spoken languages present in `catalog`.
           */
          spokenLanguages: {
            type: Array,
            value: []
          },

          showAllProgrammingLanguages: {
            type: Boolean,
            value: false
          },

          showAllSpokenLanguages: {
            type: Boolean,
            value: false
          },

          showAllProjects: {
            type: Boolean,
            value: false
          },
          showAllBooks: {
            type: Boolean,
            value: false
          }

        };
      }

      _onLoadCatalog() {
        let newProgrammingLanguages = new Map();
        let newSpokenLanguages = new Map();
        this.catalog.forEach(entry => {
          if (entry.origin === 'github') {
            if (newProgrammingLanguages.has(entry.language)) {
              newProgrammingLanguages.set(entry.language, newProgrammingLanguages.get(entry.language) + 1);
            } else {
              newProgrammingLanguages.set(entry.language, 1);
            }
          } else if (entry.origin === 'gutenberg') {
            if (newSpokenLanguages.has(entry.language)) {
              newSpokenLanguages.set(entry.language, newSpokenLanguages.get(entry.language) + 1);
            } else {
              newSpokenLanguages.set(entry.language, 1);
            }
          }
        });
        this.programmingLanguages = Array.from(new Map([...newProgrammingLanguages.entries()].sort((a,b) => a[1] > b[1] ? -1 : a[1] < b[1] ? 1 : 0)).entries());
        this.spokenLanguages = Array.from(new Map([...newSpokenLanguages.entries()].sort((a,b) => a[1] > b[1] ? -1 : a[1] < b[1] ? 1 : 0)).entries());
      }

      _filterProjects(item) {
        if (this.showAllProgrammingLanguages) {
          return true;
        }
        const index = this.programmingLanguages.indexOf(item);
        return index < 5;
      }

      _selectAllProgrammingLanguages() {
        this.showAllProgrammingLanguages = true;
        this.$.programmingLanguagesList.render();
      }
      _unselectAllProgrammingLanguages() {
        this.showAllProgrammingLanguages = false;
        this.$.programmingLanguagesList.render();
      }

      _changedType(e) {
        this.type = this.$.typeTabs.selected;
        this.$.typeCode.style.display = this.type === 'code' ? "block" : "none";
        this.$.typeLiterature.style.display = this.type === 'literature' ? "block" : "none";
      }

    }

    window.customElements.define(TypioCatalog.is, TypioCatalog);
  </script>
</dom-module>
