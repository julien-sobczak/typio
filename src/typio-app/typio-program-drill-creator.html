<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<link rel="import" href="/src/typio-app/shared-styles.html">
<link rel="import" href="/src/typio-app/typio-button.html">

<dom-module id="typio-program-drill-creator">
  <template>
    <style include="shared-styles">

      :host {
        display: block;
        text-align: center;
      }
      
      #wrapper {
        position: relative;
        height: 500px;
      }
      
      iframe {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 0;
      }
      
      #validateButton { /* TODO use typio-button? */
        position: fixed;
        bottom: 0;
        left: 50%;
        width: 150px; /* Same as .blocklyToolboxDiv */
        margin-left: -75px;
        background-color: #009ee3;
        color: white;
        font-weight: bold;
        z-index: 100;
        padding: 10px;
        text-align: center;
        text-decoration: none;
      }
      
      paper-input {
        --primary-text-color: var(--typio-bg-color);
        --secondary-text-color: white;
        --paper-input-container-color: white;
        --paper-input-container-focus-color: var(--typio-bg-color);
        --paper-font-subhead_-_font-size: 140%;
        
        width: 600px;
        margin: 0 auto;
      }
      
      p.instructions {
        margin: 20px 0;
        padding: 20px;
        background-color: rgba(255,255,255,0.1);
        color: black;
        box-shadow: 2px 2px rgba(0,0,0,0.2);
      }
      
      typio-button {
        --typio-secondary-color: black;
      }
      
    </style>
    
    <paper-input label="Descriptive name" no-label-float></paper-input>
    
    <p class="instructions"><iron-icon icon="help"></iron-icon> Use the collection of blocks to build your own program. 
      On saving, the program is run and everything displayed will be used as the drill content.
    </p>

    <div id="wrapper">
      <iframe id="blockly" title="Blockly Drill Creator" src="http://localhost:8081/blockly.html">
      </iframe>
    </div>
    
    <typio-button on-click="tryIt" light><iron-icon icon="check-box"></iron-icon> Try</typio-button>
    <typio-button on-click="save" light><iron-icon icon="save"></iron-icon> Save</typio-button>
      
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class TypioProgramDrillCreator extends Polymer.Element {
      static get is() { return 'typio-program-drill-creator'; }
      static get properties() {
        return {
        };
      }
      
      ready() {
        super.ready();
        
        this.domain = window.location.origin; 
        
        this.blockly = this.$.blockly.contentWindow;
       
        // See https://davidwalsh.name/window-postmessage for explanations about Window.postMessage()
        // Or https://developer.mozilla.org/fr/docs/Web/API/Window/postMessage
        
        function evaluate(jsText) {
          let jsUpdatedText = jsText.replace(/window\.alert\((.*?)\);/g, "res += $1;");
          let program = `
          function run() {
            let res = "";
            ${jsUpdatedText}
            return res;
          }
          run()`;
          return eval(program);
        }
        
        // periodical message sender
        setTimeout(() => {
          let xmlText = `
            <xml><variables></variables><block type="text_print" id="]!%~YmJFM+Uq0p%;xMU:" x="678" y="154"><value name="TEXT"><shadow type="text" id="0f$J;1*?.}2krhXo]FPR"><field name="TEXT">abc</field></shadow><block type="text" id="mc=vQQsn)h@Wc69rbFvH"><field name="TEXT">toto</field></block></value></block></xml>
          `;
        	this.blockly.postMessage(xmlText, this.domain); // send the message and target URI
        }, 1000); // Required?

        // listen to holla back
        window.addEventListener('message', event => { 
          if (event.origin !== this.domain)
            return;
      
        	//console.log('javascript: ', event.data.javascript);
          //console.log('xml: ', event.data.xml);
          this.result = evaluate(event.data.javascript);
          console.log('=', this.result);
          // TODO save event
          
        }, false);
      }
      
      save() {
        this.blockly.postMessage("GET", this.domain); 
      }
      
      tryIt() {
        this.blockly.postMessage("GET", this.domain); 
        setTimeout(() => {
          let detail = {
            content: this.result,
            redirectUri: '/drillCreator/program'
          };
          this.dispatchEvent(new CustomEvent('drill-session-requested', {detail: detail, bubbles: true, composed: true}));
        }, 500);
      }
      
    }

    window.customElements.define(TypioProgramDrillCreator.is, TypioProgramDrillCreator);
  </script>
</dom-module>
