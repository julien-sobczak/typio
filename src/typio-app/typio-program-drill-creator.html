<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="/src/typio-app/shared-styles.html">

<dom-module id="typio-program-drill-creator">
  <template>
    <style include="shared-styles">

      :host {
        display: block;
      }
      
      #wrapper {
        position: relative;
        height: 600px;
      }
      
      iframe {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 0;
      }
      
      #validateButton { /* TODO use typio-button? */
        position: fixed;
        bottom: 0;
        left: 50%;
        width: 150px; /* Same as .blocklyToolboxDiv */
        margin-left: -75px;
        background-color: #009ee3;
        color: white;
        font-weight: bold;
        z-index: 100;
        padding: 10px;
        text-align: center;
        text-decoration: none;
      }
      

    </style>

    <div id="wrapper">
      <iframe id="blockly" title="Blockly Drill Creator" src="http://localhost:8081/blockly.html">
      </iframe>
    </div>
    
    <a id="validateButton" href="#" on-click="save">Save</a>
  
  
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class TypioProgramDrillCreator extends Polymer.Element {
      static get is() { return 'typio-program-drill-creator'; }
      static get properties() {
        return {
        };
      }
      
      ready() {
        super.ready();
        
        this.domain = 'http://localhost:8081'; // FIXME
        
        this.blockly = this.$.blockly.contentWindow;
       
        // See https://davidwalsh.name/window-postmessage for explanations about Window.postMessage()
        // Or https://developer.mozilla.org/fr/docs/Web/API/Window/postMessage
        
        function evaluate(jsText) {
          let jsUpdatedText = jsText.replace(/window\.alert\((.*?)\);/g, "res += $1;");
          let program = `
          function run() {
            let res = "";
            ${jsUpdatedText}
            return res;
          }
          run()`;
          return eval(program);
        }
        
        // periodical message sender
        setTimeout(() => {
          let xmlText = `
            <xml><variables></variables><block type="text_print" id="]!%~YmJFM+Uq0p%;xMU:" x="678" y="154"><value name="TEXT"><shadow type="text" id="0f$J;1*?.}2krhXo]FPR"><field name="TEXT">abc</field></shadow><block type="text" id="mc=vQQsn)h@Wc69rbFvH"><field name="TEXT">toto</field></block></value></block></xml>
          `;
        	this.blockly.postMessage(xmlText, this.domain); // send the message and target URI
        }, 1000); // Required?

        // listen to holla back
        window.addEventListener('message', event => { 
          if (event.origin !== this.domain)
            return;
      
        	//console.log('javascript: ', event.data.javascript);
          //console.log('xml: ', event.data.xml);
          this.result = evaluate(event.data.javascript);
          console.log('=', this.result);
          
          // TODO display event
          
        }, false);
      }
      
      save() {
        this.blockly.postMessage("GET", this.domain); 
      }
    }

    window.customElements.define(TypioProgramDrillCreator.is, TypioProgramDrillCreator);
  </script>
</dom-module>
